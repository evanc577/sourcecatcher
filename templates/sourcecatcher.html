<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sourcecatcher</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='sourcecatcher.css') }}?{{ sha256(url_for('static', filename='sourcecatcher.css')) }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='tweet.css') }}?{{ sha256(url_for('static', filename='tweet.css')) }}">
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="{{ url_for('static', filename='favicons/apple-touch-icon-57x57.png') }}" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="{{ url_for('static', filename='favicons/apple-touch-icon-114x114.png') }}" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="{{ url_for('static', filename='favicons/apple-touch-icon-72x72.png') }}" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="{{ url_for('static', filename='favicons/apple-touch-icon-144x144.png') }}" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="{{ url_for('static', filename='favicons/apple-touch-icon-60x60.png') }}" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="{{ url_for('static', filename='favicons/apple-touch-icon-120x120.png') }}" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="{{ url_for('static', filename='favicons/apple-touch-icon-76x76.png') }}" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="{{ url_for('static', filename='favicons/apple-touch-icon-152x152.png') }}" />
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicons/favicon-196x196.png') }}" sizes="196x196" />
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicons/favicon-96x96.png') }}" sizes="96x96" />
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicons/favicon-32x32.png') }}" sizes="32x32" />
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicons/favicon-16x16.png') }}" sizes="16x16" />
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicons/favicon-128.png') }}" sizes="128x128" />
  </head>
  <body>
    <div id="dnd-modal">
      <div id="dnd-modal-content">
        Drag image here to search
      </div>
    </div>
    <div id="content">
    <div class="banner">
      <a href="/"><h1>Sourcecatcher</h1></a>
    </div>
    <div class="main">
      <div class="description">
        <p>Find the Twitter source of a Dreamcatcher fansite photo</p>
        <p class="message"><em>NEW!</em> Paste a link from the Dreamcatcher official app to get full size photos</p>
      </div>

      {% block forms %}
      <div class="inputs">
        <div class="search_wrap">
          <form action="/link">
            {% if url %}
            <input id="link_input" type="text" name="url" required placeholder="https://i.imgur.com/QQDz93b.jpg" value="{{ url|e }}" autocomplete="url">
            {% else %}
            <input id="link_input" type="text" name="url" required placeholder="https://i.imgur.com/QQDz93b.jpg" autocomplete="url">
            {% endif %}
            <button id="link_submit_btn" type="submit" value="submit">
              <svg id="search_icon" viewBox="0 0 30 30" fill="none" stroke="#999" stroke-width="2">
                <circle cx="13" cy="13" r="9"/>
                <path d="M26 26l-6.563-6.563" stroke-linecap="round" stroke-miterlimit="10"/>
              </svg>
            </button>
          </form>
        </div>
        <p id="or">OR</p>
        <form id="file_upload_form" action="/upload" method="post" enctype="multipart/form-data">
          <input id="file_input" type="file" name="file" required onchange="form.submit();">
          <label for="file_input" id="file_input_label"/>Upload an image</label>
          <script>
            // show pretty file upload form if js is available
            var file_input = document.getElementById('file_input');
            var file_input_label = document.getElementById('file_input_label');
            file_input.style.width = '1px';
            file_input.style.height = '1px';
            file_input.style.overflow = 'hidden';
            file_input.style.clip = 'rect(0,0,0,0)';
            file_input.style.padding = '0';
            file_input.style.position = 'absoulute !important';
            file_input.style.whiteSpace = 'nowrap';
            file_input.style.border = 0;
            file_input.style.opacity = 0;
            file_input_label.style.display = 'inline-block';
          </script>
          <noscript>
            <button type="submit" value="submit">
              Upload
            </button>
          </noscript>
        </form>
      </div>
      {% endblock forms %}

      {% block error_msg %}
      {% endblock error_msg %}

      {% block results %}
      {% endblock results %}

    </div>
    </div>
    <div id="footer_wrapper">
    <div id="footer">
      <p class="footer_text">
      Indexing {{ num_photos }} photos from {{ num_tweets }} tweets
      </p>
      <p class="footer_text">
      Updated {{ mtime }} ago
      </p>
      <p class="footer_text">
      <a href="twitter_users">All indexed Twitter users</a>
      </p>
      <p class="footer_text">
      Contact <a target="_blank" rel="noopener noreferrer" title="Contact u/ipwnmice" href="https://www.reddit.com/u/ipwnmice">/u/ipwnmice</a>
      </p>
    </div>
    </div>
    <script>
      // File drag and drop support
      let enterTarget = null;
      let dropPopup = document.getElementById('dnd-modal');
      let form = document.getElementById('file_upload_form');
      let input = document.getElementById('file_input');

      function containsFiles(event) {
        if (event.dataTransfer.types) {
          for (var i = 0; i < event.dataTransfer.types.length; i++) {
            if (event.dataTransfer.types[i] == "Files") {
              return true;
            }
          }
        }
        return false;
      };
      document.ondragenter = function(event) {
        if (containsFiles(event)) {
          event.stopPropagation();
          event.preventDefault();
          enterTarget = event.target;
          dropPopup.style.display = 'block';
        }
      };
      document.ondragleave = function(event) {
        if (containsFiles(event)) {
          event.stopPropagation();
          event.preventDefault();
          //Only if the two target are equal it means the drag has left the window
          if (enterTarget == event.target){
            dropPopup.style.display = 'none';
          }
        }
      };
      document.ondragover = function(event) {
        if (containsFiles(event)) {
          event.preventDefault();
        }
      };
      document.ondrop = function(event) {
        if (containsFiles(event)) {
          event.stopPropagation();
          event.preventDefault();
          dropPopup.style.display = 'none';
          if (event.dataTransfer.files && event.dataTransfer.files.length) {
            input.files = event.dataTransfer.files;
            form.submit();
          }
        }
      };

      // hack to select all text on first click
      var link_input = document.getElementById("link_input")
      var focusedElement;
      link_input.onfocus = function() {
        if (focusedElement == this) return;
        focusedElement = this;
        setTimeout(function() { focusedElement.select(); }, 0);
      };
      link_input.onblur = function() {
        focusedElement = null;
      };

      // change search button color automatically
      var search_button = document.getElementById("link_submit_btn")
      function text_input_change() {
        if (link_input.value.length == 0) {
          search_button.classList.remove('highlight_search');
        } else {
          search_button.classList.add('highlight_search');
        }
      }
      ['input','keyup', 'keydown', 'paste', 'change'].forEach(e => 
          link_input.addEventListener(e, text_input_change, false)
      );
      text_input_change();
    </script>
  </body>
</html>
